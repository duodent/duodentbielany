{% extends 'base.html' %}
{% block content %}
<!-- page banner -->
{% set bg_image_login =url_for('static', filename='img/banners/login-1-banner.jpg') %}
<div class="page-banner-area mb-5" style="background-image: url('{{ bg_image_login }}');">
    <div class="container">
        <div class="page-banner-content">
            <h2>Zarządzanie witryną - {{pageTitle}}</h2>
            <ul class="pages-list">
                <li><a href="/">Duodent Bielany</a></li>
                <li>Rejestracja</li>
            </ul>
        </div>
    </div>
</div>
<!-- page banner end -->
 <!-- register-area -->
 <section class="login-area ptb-100">
    <div class="container">
        <div class="login-form">
            <div class="login-header">
                <h2>Rejestracja</h2>
                <p>Tworzenie konta pracownika w systemie Duodent Bielany</p>
            </div>
            <form id="form-register-worker">
                <div class="row">
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="login">Login</label>
                            <input type="text" class="form-control" id="login" name="login" placeholder="Wpisz login">
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="fullName">Imię i nazwisko</label>
                            <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Wpisz imię i nazwisko">
                        </div>
                    </div>
            
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="position">Stanowisko</label>
                            <input type="text" class="form-control" id="position" name="position" placeholder="Wpisz stanowisko">
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="qualifications">Kwalifikacje</label>
                            <input type="text" class="form-control" id="qualifications" name="qualifications" placeholder="Wpisz kwalifikacje">
                        </div>
                    </div>
            
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="experience">Doświadczenie zawodowe</label>
                            <textarea class="form-control" id="experience" name="experience" placeholder="Opisz doświadczenie zawodowe" style="height: 100px;"></textarea>
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="education">Wykształcenie</label>
                            <input type="text" class="form-control" id="education" name="education" placeholder="Wpisz wykształcenie">
                        </div>
                    </div>
            
                    <div class="col-lg-12 col-sm-12">
                        <div class="form-group">
                            <label for="description">Opis pracownika</label>
                            <textarea class="form-control" id="description" name="description" placeholder="Dodaj opis pracownika" style="height: 100px;"></textarea>
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="Wpisz email">
                        </div>
                    </div>
            
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="phone">Telefon</label>
                            <input type="text" class="form-control" id="phone" name="phone" placeholder="Wpisz numer telefonu">
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="facebook">Facebook</label>
                            <input type="text" class="form-control" id="facebook" name="facebook" placeholder="Link do profilu na Facebooku">
                        </div>
                    </div>
            
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="instagram">Instagram</label>
                            <input type="text" class="form-control" id="instagram" name="instagram" placeholder="Link do profilu na Instagramie">
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="twitter">Twitter</label>
                            <input type="text" class="form-control" id="twitter" name="twitter" placeholder="Link do profilu na Twitterze">
                        </div>
                    </div>
            
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="text" class="form-control" id="linkedin" name="linkedin" placeholder="Link do profilu na LinkedIn">
                        </div>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="password">Hasło</label>
                            <input type="password" class="form-control" id="password" name="password" placeholder="Wpisz hasło">
                        </div>
                    </div>
            
                    <div class="col-lg-6 col-sm-12">
                        <div class="form-group">
                            <label for="confirmPassword">Potwierdź hasło</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Potwierdź hasło">
                        </div>
                    </div>
            
                    <div class="col-lg-6 col-sm-12">
                        <!-- Pole do przesyłania zdjęcia -->
                        <div class="form-group custom-file-upload">
                            <label for="photo">Zdjęcie pracownika</label>
                            <div class="file-input-wrapper">
                                <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
                                <span class="file-label"><i class="fas fa-upload upload-icon me-3"></i> Prześlij zdjęcie</span>
                            </div>
                        </div>
                    </div>
            
                    <div class="col-lg-12">
                        <!-- Sekcja uprawnień -->
                        <div class="form-group">
                            <label>Uprawnienia</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="administrator" id="roleAdministrator" name="roles[]">
                                <label class="form-check-label" for="roleAdministrator">
                                    Administrator
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="super_user" id="roleSuperUser" name="roles[]">
                                <label class="form-check-label" for="roleSuperUser">
                                    Super User
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="user" id="roleUser" name="roles[]">
                                <label class="form-check-label" for="roleUser">
                                    Pracownik
                                </label>
                            </div>
                        </div>
                    </div>
            
                    <div class="col-lg-12">
                        <button type="submit" class="btn btn-primary">Zarejestruj</button>
                        <div id="form-feedback" class="mt-3"></div> <!-- Miejsce na komunikaty -->
                    </div>
                </div>
            </form>
            
            
        </div>
    </div>
</section>
<!-- register-area end -->

{% endblock %}
{% block bottom_scripts %}
<script>
    document.querySelector('#photo').addEventListener('change', function () {
        const label = this.nextElementSibling;
        label.textContent = this.files.length ? this.files[0].name : "Prześlij zdjęcie";
    });

    function validateForm() {
        let isValid = true; // Flaga walidacji

        // Funkcja pomocnicza do podświetlania pól
        function highlightField(field, message) {
            const formGroup = field.closest('.form-group');
            formGroup.classList.add('has-error'); // Dodaj klasę dla błędu
            formGroup.querySelector('.error-message')?.remove(); // Usuń istniejący komunikat błędu
            
            // Dodaj komunikat błędu
            const error = document.createElement('small');
            error.className = 'error-message text-danger';
            error.textContent = message;
            formGroup.appendChild(error);
        }

        // Funkcja do resetowania stylów
        function resetField(field) {
            const formGroup = field.closest('.form-group');
            formGroup.classList.remove('has-error'); // Usuń klasę błędu
            formGroup.querySelector('.error-message')?.remove(); // Usuń komunikat błędu
        }

        // Pobieranie wartości pól
        const login = document.getElementById('login');
        const fullName = document.getElementById('fullName');
        const email = document.getElementById('email');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');
        const roles = document.querySelector('input[name="roles[]"]:checked');
        const fieldsToValidate = [login, fullName, email, password, confirmPassword];

        // Resetuj style przed walidacją
        fieldsToValidate.forEach(resetField);

        // Pola wymagane
        if (!login.value.trim()) {
            highlightField(login, "Pole 'Login' jest wymagane.");
            isValid = false;
        }
        if (!fullName.value.trim()) {
            highlightField(fullName, "Pole 'Imię i nazwisko' jest wymagane.");
            isValid = false;
        }
        if (!email.value.trim()) {
            highlightField(email, "Pole 'Email' jest wymagane.");
            isValid = false;
        }
        if (!password.value.trim()) {
            highlightField(password, "Pole 'Hasło' jest wymagane.");
            isValid = false;
        }
        if (!confirmPassword.value.trim()) {
            highlightField(confirmPassword, "Pole 'Potwierdź hasło' jest wymagane.");
            isValid = false;
        }
        if (password.value !== confirmPassword.value) {
            highlightField(confirmPassword, "Hasła muszą się zgadzać.");
            isValid = false;
        }

        // Dodatkowa walidacja dla roli pracownika
        if (roles && roles.value === 'user') {
            const position = document.getElementById('position');
            const qualifications = document.getElementById('qualifications');
            const experience = document.getElementById('experience');
            const education = document.getElementById('education');
            const description = document.getElementById('description');

            const workerFields = [position, qualifications, experience, education, description];
            workerFields.forEach(resetField);

            workerFields.forEach(field => {
                if (!field.value.trim()) {
                    highlightField(field, `Pole '${field.previousElementSibling.textContent}' jest wymagane.`);
                    isValid = false;
                }
            });
        }

        return isValid; // Zwróć flagę walidacji
    }

    // Podłącz walidację do formularza
    $('form').on('submit', function (e) {
        e.preventDefault();

        const feedbackContainer = document.getElementById('form-feedback');
        feedbackContainer.textContent = ''; // Resetuj komunikaty

        if (validateForm()) {
            const formData = new FormData(this);
            $.ajax({
                url: '/api/register',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    feedbackContainer.textContent = 'Rejestracja zakończona sukcesem!';
                    feedbackContainer.className = 'text-success mt-3';

                    // Odczekaj 3 sekundy i ukryj komunikat
                    setTimeout(function () {
                        feedbackContainer.style.opacity = '0'; // Animacja zanikania
                        setTimeout(function () {
                            document.getElementById('form-register-worker').reset(); // Czyść formularz

                            // Resetowanie pola zdjęcia
                            document.getElementById('photo').value = '';
                            document.querySelector('#photo').nextElementSibling.innerHTML = '<i class="fas fa-upload upload-icon me-3"></i> Prześlij zdjęcie';
                            
                            feedbackContainer.textContent = ''; // Usuwanie komunikatu
                            feedbackContainer.className = '';
                            feedbackContainer.style.opacity = '1'; // Resetowanie stylu
                        }, 1000); // Czas na zakończenie animacji (1 sekunda)
                    }, 3000); // 3 sekundy na przeczytanie
                },
                error: function (xhr) {
                    try {
                        // Parsowanie odpowiedzi JSON
                        const response = JSON.parse(xhr.responseText);
                        if (response.errors && Array.isArray(response.errors)) {
                            // Wyświetlanie listy błędów
                            feedbackContainer.textContent = response.errors.join(' ');
                        } else {
                            feedbackContainer.textContent = 'Wystąpił błąd: Nieznany format odpowiedzi.';
                        }
                    } catch (e) {
                        // W przypadku błędu parsowania JSON
                        feedbackContainer.textContent = 'Wystąpił błąd: ' + xhr.responseText;
                    }
                    feedbackContainer.className = 'text-danger mt-3';
                }
            });
        }
    });

</script>

{% endblock %}