{% extends 'base.html' %}
{% block content %}
<!-- Modal dla podglądu filmu -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoModalLabel">Podgląd filmu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <iframe id="videoFrame" width="100%" height="315" src="" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>

<!-- breadcrumb start -->
<div id="breadcrumb-small" class="breadcrumb-small mb-0" style="display: none;">
    <div class="container justify-content-center">
        <div class="justify-content-center">
            <ul class="breadcrumb-pages-list">
                <li><a href="/"><i class="bi bi-houses-fill" style="font-size: 1rem;"></i></a></li>
                <li>Filmy</li>
            </ul>
        </div>
    </div>
</div>
<!-- breadcrumb end -->

<section class="video-area ptb-100">
    <div class="container">
        <!-- Sekcja tytułu -->
        <div class="row align-items-center">
            <div class="col-lg-6 mx-auto">
                <div class="section-title-warp">
                    <span class="sub-title">
                        <i class="flaticon-hashtag-symbol"></i>
                        Filmy na stronie
                    </span>
                    <h2>Zarządzaj <span>filmami</span> na stronie <span>www</span></h2>
                    <p>Dodaj, zmieniaj kolejność, usuwaj i zarządzaj aktywnym filmem dla każdego koloru „oka”.</p>
                </div>
            </div>
        </div>

        <!-- Formularz dodawania filmu -->
        <div class="row mt-4">
            <div class="col-lg-12 mx-auto">
                <form id="addVideoForm">
                    <div class="row">
                        <div class="col-lg-6 col-sm-12">
                            <!-- Podgląd filmu -->
                            <div id="videoPreviewContainer" class="mb-3 text-center" style="display: none;">
                                <iframe id="videoPreview" width="100%" height="250" frameborder="0" allowfullscreen></iframe>
                                <p id="videoErrorMessage" class="text-danger mt-2" style="display: none;">Nie można wyświetlić podglądu filmu. Sprawdź link.</p>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="url" class="form-control" id="videoUrl" name="videoUrl" placeholder="Link do filmu" required>
                                <label for="videoUrl">Link do filmu YouTube</label>
                            </div>
                        </div>

                        <div class="col-lg-6 col-sm-12">
                            <div class="form-floating mb-3">
                                <select class="form-control" id="eyeColor" name="eyeColor" required>
                                    <option value="blue">Niebieskie</option>
                                    <option value="green">Zielone</option>
                                    <option value="red">Czerwone</option>
                                </select>
                                <label for="eyeColor">Kolor oka</label>
                            </div>
                            <button type="submit" id="submitVideo" class="default-btn mb-3 w-100" disabled>Dodaj film</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>


        <!-- Lista filmów -->
        <div class="row mt-5 video-area" id="video-list-sort">
            {% if videos %}
                {% for video in videos|reverse %}  <!-- Ostatnie dodane pierwsze -->
                    <div class="col-lg-4 col-md-6 col-sm-12" data-url="{{ video.video_url }}" data-color="{{ video.color }}">
                        <div class="single-video-item">
                            <!-- Podgląd filmu w modalu -->
                            <div class="checkup-content text-center">
                                <a href="#" class="open-video" data-bs-toggle="modal" data-bs-target="#videoModal" data-url="{{ video.video_url }}">
                                    <i class="far fa-play"></i>
                                </a>
                                <span>Zobacz film</span>
                            </div>

                            <!-- Ikony oczu + kosz -->
                            <div class="video-info d-flex justify-content-between align-items-center mt-3">
                                <div class="eye-icons">
                                    {% if video.color == 'blue' %}
                                        <i class="bi bi-eye-fill eye-toggle blue-eye" data-url="{{ video.video_url }}" data-color="blue" style="color:#007bff;"></i>
                                    {% else %}
                                        <i class="bi bi-eye-fill eye-toggle blue-eye" data-url="{{ video.video_url }}" data-color="blue" style="color:#a6c8ff;"></i>
                                    {% endif %}

                                    {% if video.color == 'green' %}
                                        <i class="bi bi-eye-fill eye-toggle green-eye" data-url="{{ video.video_url }}" data-color="green" style="color:#28a745;"></i>
                                    {% else %}
                                        <i class="bi bi-eye-fill eye-toggle green-eye" data-url="{{ video.video_url }}" data-color="green" style="color:#a6d3a0;"></i>
                                    {% endif %}

                                    {% if video.color == 'red' %}
                                        <i class="bi bi-eye-fill eye-toggle red-eye" data-url="{{ video.video_url }}" data-color="red" style="color:#dc3545;"></i>
                                    {% else %}
                                        <i class="bi bi-eye-fill eye-toggle red-eye" data-url="{{ video.video_url }}" data-color="red" style="color:#f5a6a6;"></i>
                                    {% endif %}
                                </div>
                                <a class="delete-video" data-to-del="{{ video.video_url }}">
                                    <i class="bi bi-trash3-fill" style="font-size: 1rem; color: red;"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

    </div>
</section>

{% endblock %}
{% block bottom_scripts %}
<script>
    $(document).ready(function () {
        setTimeout(function () {
            $("#breadcrumb-small")
                .css({
                    display: "block",
                    textAlign: "center",
                    width: "100%",
                })
                .animate(
                    {
                        height: "50px",
                        paddingTop: "10px"
                    },
                    1200
                );
        }, 2000); 
    });

    // Obsługa formularza dodawania filmu
    $('#addVideoForm').on('submit', function (e) {
        e.preventDefault();

        const data = {
            videoUrl: $('#videoUrl').val(),
            eyeColor: $('#eyeColor').val()
        };

        $.ajax({
            url: '/api/add-video',
            method: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Błąd podczas dodawania filmu.');
                }
            },
            error: function () {
                alert('Wystąpił błąd podczas połączenia z serwerem.');
            }
        });
    });

    // Obsługa otwierania filmu w modalu
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.open-video').forEach(button => {
            button.addEventListener('click', function() {
                const videoUrl = this.getAttribute('data-url');
                document.getElementById('videoFrame').src = videoUrl;
            });
        });

        // Obsługa zmiany aktywnego filmu dla danego koloru (fetch zamiast $.ajax)
        document.querySelectorAll('.eye-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const videoUrl = this.getAttribute('data-url');
                const color = this.getAttribute('data-color');

                console.log("Kliknięto oko:", { videoUrl, color });

                if (!videoUrl || !color) {
                    alert("Błąd: Brak wymaganych danych! Sprawdź atrybuty data-url i data-color.");
                    return;
                }

                fetch('/api/set-active-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoUrl: videoUrl, color: color })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelectorAll(`.eye-toggle[data-color="${color}"]`).forEach(icon => {
                            icon.style.color = '#a6c8ff';
                        });

                        this.style.color = color === 'blue' ? '#007bff' : color === 'green' ? '#28a745' : '#dc3545';
                    } else {
                        alert("Błąd: " + data.message);
                    }
                })
                .catch(error => alert("Błąd podczas zmiany aktywnego filmu."));
            });
        });


        // Obsługa usuwania filmu (fetch zamiast $.ajax)
        document.querySelectorAll('.delete-video').forEach(button => {
            button.addEventListener('click', function() {
                const videoUrl = this.getAttribute('data-to-del');

                if (!videoUrl) {
                    alert("Błąd: Brak adresu URL filmu!");
                    return;
                }

                if (!confirm("Czy na pewno chcesz usunąć ten film?")) return;

                fetch('/api/delete-video', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoUrl: videoUrl })  // Używamy `videoUrl`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert("Błąd: " + data.message);
                    }
                })
                .catch(error => alert("Błąd podczas usuwania filmu."));
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const videoUrlInput = document.getElementById('videoUrl');
        const videoPreviewContainer = document.getElementById('videoPreviewContainer');
        const videoPreview = document.getElementById('videoPreview');
        const videoErrorMessage = document.getElementById('videoErrorMessage');
        const submitButton = document.getElementById('submitVideo');
    
        function updatePreview() {
            const url = videoUrlInput.value.trim();
            if (!url) {
                videoPreviewContainer.style.display = "none";
                submitButton.disabled = true;
                return;
            }
    
            // Tworzymy link do `embed` YouTube
            let videoId = extractYouTubeID(url);
            if (!videoId) {
                showError();
                return;
            }
    
            let embedUrl = `https://www.youtube.com/embed/${videoId}`;
    
            // Sprawdzamy, czy wideo jest dostępne
            checkYouTubeVideo(videoId, function(isValid) {
                if (isValid) {
                    showPreview(embedUrl);
                } else {
                    showError();
                }
            });
        }
    
        function showPreview(embedUrl) {
            videoPreview.src = embedUrl;
            videoPreviewContainer.style.display = "block";
            videoErrorMessage.style.display = "none";
            submitButton.disabled = false;
        }
    
        function showError() {
            videoPreviewContainer.style.display = "block";
            videoPreview.src = "";
            videoErrorMessage.style.display = "block";
            submitButton.disabled = true;
        }
    
        function extractYouTubeID(url) {
            const patterns = [
                /(?:youtube\.com\/.*[?&]v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([A-Za-z0-9_-]{11})/,
                /^([A-Za-z0-9_-]{11})$/ // Jeśli użytkownik wklei tylko ID filmu
            ];

            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

    
        function checkYouTubeVideo(videoId, callback) {
            const img = new Image();
            img.src = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
            img.onload = function () {
                if (img.width === 120) { // Jeśli miniatura 120px szerokości, to wideo nie istnieje
                    callback(false);
                } else {
                    callback(true);
                }
            };
            img.onerror = function () {
                callback(false);
            };
        }
    
        videoUrlInput.addEventListener('input', updatePreview);
    });
</script>

{% endblock %}
