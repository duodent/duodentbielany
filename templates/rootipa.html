{% extends 'base.html' %}
{% block content %}
    <!-- breadcrumb start -->
    <div id="breadcrumb-small" class="breadcrumb-small mb-5" style="display: none;">
        <div class="container justify-content-center">
            <div class="justify-content-center">
                <ul class="breadcrumb-pages-list">
                    <li><a href="/"><i class="bi bi-houses-fill" style="font-size: 1rem;"></i></a></li>
                    <li>Ustawienia</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- breadcrumb end -->
    {% if userName!='NotLogin' %}
        <!-- appointment -->
        <section class="root-area">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 col-md-12">
                        <div class="dentist-details-image">
                            <img 
                                id="team-avatar-{{own_user_data.id}}-1-1"
                                data-editable 
                                data-type="img"
                                src="{{own_user_data.avatar}}" alt="image">
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="appointment-overview-box">
                            <div class="make-appointment-content">
                                <h4><i class="far fa-key"></i> Zarządzanie hasłem</h4>
                                <form id="passwordForm">
                                    <div class="row">
                                        <!-- Ukryte pole input -->
                                        <input type="hidden" id="user_id" name="user_id" value="{{ own_user_data.id }}">
                                        <!-- Informacje o użytkowniku (tylko dla administratora) -->
                                        <div class="col-lg-12" id="userSelect" style="display: none;">
                                            <div>
                                                <p style="font-size: 10px; margin-bottom: 1px !important; color: #686a6b;">Wybierz użytkownika</p>

                                                <!-- Wybrany użytkownik (link otwierający collapse) -->
                                                <a 
                                                    class="btn btn-link p-0 mb-2" 
                                                    data-bs-toggle="collapse" 
                                                    href="#userListCollapse" 
                                                    role="button" 
                                                    aria-expanded="false" 
                                                    aria-controls="userListCollapse"
                                                    id="selectedUserName"
                                                    >
                                                    {{ own_user_data.name }}
                                                </a>
                                            </div>
                                            {% for permission in superuser_worker_select %}
                                                <div id="perm-show-{{permission.id}}" style="display: none;">
                                                    <a 
                                                        class="p-0 mb-2" 
                                                        data-bs-toggle="collapse" 
                                                        href="#permListCollapse-{{permission.id}}" 
                                                        role="button" 
                                                        aria-expanded="false" 
                                                        aria-controls="permListCollapse-{{permission.id}}"
                                                        
                                                        >
                                                        <!-- id="adminPerm" -->
                                                        {% if permission.roles.administrator %}
                                                            <i class="bi-shield-lock-fill text-info ms-1 me-1"></i> 
                                                        {% else %}
                                                            <i class="bi-shield-lock-fill text-secondary ms-1 me-1"></i> 
                                                        {% endif %}
                                                        {% if permission.roles.super_user %}
                                                            <i class="bi-shield-check text-info me-1"></i> 
                                                        {% else %}
                                                            <i class="bi-shield-check text-secondary me-1"></i> 
                                                        {% endif %}
                                                        {% if permission.roles.user %}
                                                            <i class="bi-person-fill text-info me-1"></i>  
                                                        {% else %}
                                                            <i class="bi-person-fill text-secondary me-1"></i> 
                                                        {% endif %}
                                                    </a> 
                                                </div>
                                                <div class="collapse" id="permListCollapse-{{permission.id}}">
                                                    <div id="perm-edit-{{permission.id}}" style="display: none;">
                                                        <!-- Opcje Administratora i Uprawnienia -->
                                                        {% if permission.roles.administrator %}
                                                            <i  
                                                                title="Odbierz uprawnienia administratora" 
                                                                id="team-administrator-{{permission.id}}-1-1" 
                                                                data-type="switch" 
                                                                data-state="{{permission.roles.administrator}}"
                                                                class="bi-shield-lock-fill icon-size text-info me-1"></i> 
                                                                <span class="fw-light me-1 ms-1">
                                                                    Administrator <!-- Administrator -->
                                                                </span>
                                                        {% else %}
                                                            <i 
                                                                title="Przyznaj uprawnienia administratora" 
                                                                id="team-administrator-{{permission.id}}-1-1" 
                                                                data-type="switch" 
                                                                data-state="{{permission.roles.administrator}}"
                                                                class="bi-shield-lock-fill icon-size text-secondary"></i> 
                                                                <span class="fw-light me-1 ms-1">
                                                                    Administrator <!-- Administrator -->
                                                                </span><!-- Administrator -->
                                                        {% endif %}
                                                        {% if permission.roles.super_user %}
                                                            <i 
                                                                title="Odbierz uprawnienia super użytkownika" 
                                                                id="team-super_user-{{permission.id}}-1-1" 
                                                                data-type="switch" 
                                                                data-state="{{permission.roles.super_user}}"
                                                                class="bi-shield-check icon-size text-info"></i>
                                                                <span class="fw-light me-1 ms-1">
                                                                    Super User <!-- Super User -->
                                                                </span> <!-- Super User -->
                                                        {% else %}
                                                            <i 
                                                                title="Przyznaj uprawnienia super użytkownika" 
                                                                id="team-super_user-{{permission.id}}-1-1" 
                                                                data-type="switch" 
                                                                data-state="{{permission.roles.super_user}}"
                                                                class="bi-shield-check icon-size text-secondary"></i>
                                                                <span class="fw-light me-1 ms-1">
                                                                    Super User <!-- Super User -->
                                                                </span> <!-- Super User -->
                                                                
                                                        {% endif %}
                                                        {% if permission.roles.user %}
                                                            <i 
                                                                title="Odbierz uprawnienia pracownika" 
                                                                id="team-user-{{permission.id}}-1-1" 
                                                                data-type="switch" 
                                                                data-state="{{permission.roles.user}}"
                                                                class="bi-person-fill icon-size text-info"></i> <!-- User -->
                                                                <span class="fw-light me-1 ms-1">
                                                                    Pracownik <!-- Pracownik -->
                                                                </span> <!-- Pracownik -->
                                                        {% else %}
                                                            <i 
                                                                title="Przyznaj uprawnienia pracownika" 
                                                                id="team-user-{{permission.id}}-1-1" 
                                                                data-type="switch" 
                                                                data-state="{{permission.roles.user}}"
                                                                class="bi-person-fill icon-size text-secondary"></i> <!-- User -->
                                                                <span class="fw-light me-1 ms-1">
                                                                    Pracownik <!-- Pracownik -->
                                                                </span> <!-- Pracownik -->
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-lg-12">
                                            <!-- Lista użytkowników w collapse -->
                                            <div class="collapse" id="userListCollapse">
                                                {% if superuser_worker_select %}
                                                    

                                                    <!-- Wyświetlanie pozostałych użytkowników w zależności od roli -->
                                                    <div class="row">
                                                        <!-- Wyświetlanie aktualnie zalogowanego użytkownika -->
                                                            <div 
                                                                class="col-auto m-1 user-item text-center border p-1 rounded active" 
                                                                data-user-id="{{ own_user_data.id }}" 
                                                                data-user-name="{{ own_user_data.name }}"
                                                                style="cursor: pointer; min-width: max-content;  font-size: 13px;"
                                                            >
                                                            {{ own_user_data.name }}
                                                        </div>
                                                        {% for alloweduser in superuser_worker_select %}
                                                            {% if 
                                                                (user_role == 'administrator' and alloweduser.role != 'administrator') or
                                                                (user_role == 'super_user' and alloweduser.role == 'user')
                                                            %}
                                                                {% if own_user_data.id != alloweduser.id %}
                                                                    <div 
                                                                        class="col-auto m-1 user-item text-center border p-1 rounded" 
                                                                        data-user-id="{{ alloweduser.id }}" 
                                                                        data-user-name="{{ alloweduser.name }}"
                                                                        style="cursor: pointer; min-width: max-content; font-size: 13px;"
                                                                    >
                                                                        {{ alloweduser.name }}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="row">
                                                <!-- Stare hasło (wymagane dla super usera zmienia ręcznie) -->
                                                <div class="col-lg-6" id="old_password_div">
                                                    <div class="form-group">
                                                        <!-- <label>Stare Hasło</label> -->
                                                        <input type="password" class="form-control" id="old_password" name="old_password" placeholder="Stare Hasło">
                                                    </div>
                                                </div>

                                                <!-- Nowe hasło (opcjonalne, jeśli admin zmienia ręcznie) -->
                                                <div class="col-lg-6">
                                                    <div class="form-group">
                                                        <!-- <label>Nowe Hasło</label> -->
                                                        <input type="password" class="form-control" id="new_password" name="new_password" placeholder="Nowe Hasło">
                                                    </div>
                                                </div>
                                        
                                                <div class="col-lg-6">
                                                    <div class="form-group">
                                                        <!-- <label>Powtórz Nowe Hasło</label> -->
                                                        <input type="password" class="form-control" id="repeat_password" name="repeat_password" placeholder="Powtórz Nowe Hasło">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                
                                        <!-- Przełączniki dla administratora -->
                                        <div class="col-lg-12" id="adminOptions" style="display: none;">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" role="switch" id="generate_password" name="generate_password">
                                                <label class="form-check-label" for="generate_password">Wygeneruj hasło automatycznie</label>
                                            </div>
                                        </div>
                                
                                        <!-- Informacje -->
                                        <div class="col-lg-12">
                                            <p style="font-size: 12px; color: #686d71;">
                                                <strong style="color: #d60000;">UWAGA:</strong> 
                                                Hasło zostanie zmienione automatycznie po zatwierdzeniu. Przed dokonaniem zmiany upewnij się, że użytkownik ma 
                                                dostęp do swojego konta e-mail, ponieważ nowe hasło zostanie wysłane na adres zapisany w systemie. 
                                                Jeśli adres e-mail jest nieaktualny lub użytkownik nie ma do niego dostępu, zaktualizuj dane kontaktowe, 
                                                aby uniknąć problemów z logowaniem. Zmiana hasła jest nieodwracalna, dlatego zalecamy ostrożność 
                                                przy wprowadzaniu danych.
                                            </p>
                                                                                       
                                        </div>
                                    </div>
                                
                                    <!-- Przyciski akcji -->
                                    <div class="d-flex justify-content-between mt-2">
                                        <!-- Guzik dla administratora i super użytkownika -->
                                        <button type="submit" id="submitButton" class="default-btn">Zmień Hasło</button>
                                
                                        <!-- Guzik dla pracownika -->
                                        <input type="hidden" id="own_user_id" value="{{own_user_data.id}}" style="display: none;" >
                                        <button type="submit" id="generateButton" class="default-btn" style="display: none;">Wygeneruj Hasło</button>
                                    </div>
                                
                                    <div id="responseMessage" style="display: none; margin-top: 20px;" class="alert" role="alert"></div>
                                </form>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h4><i class="bi bi-person-rolodex"></i> Ustawienia Kontaktu</h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-auto m-2">
                                        <!-- Email -->
                                        <div class="d-flex text-primary">
                                            <i class="bi-envelope-fill icon-size"></i>
                                            <div 
                                                id="team-email-{{own_user_data.id}}-1-1"
                                                data-editable 
                                                data-type="text"
                                                class="border rounded border-secondary-subtle p-2 ms-2 mb-2 text-secondary" 
                                                style="min-width: 200px;">
                                                {{ own_user_data.email }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto m-2">
                                
                                        <!-- Numer telefonu -->
                                        <div class="d-flex text-success">
                                            <i class="bi-telephone-fill icon-size"></i>
                                            <div 
                                                id="team-phone-{{own_user_data.id}}-1-1"
                                                data-editable 
                                                data-type="text"
                                                class="border rounded border-secondary-subtle p-2 ms-2 mb-2 text-secondary" 
                                                style="min-width: 200px;">
                                                {{ own_user_data.contact.phone }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto m-2">  
                                        <!-- Facebook -->
                                        <div class="d-flex text-info">
                                            <i class="bi-facebook icon-size"></i>
                                            <div 
                                                id="team-facebook-{{own_user_data.id}}-1-1"
                                                data-editable 
                                                data-type="text"
                                                class="border rounded border-secondary-subtle p-2 ms-2 mb-2 text-secondary" 
                                                style="min-width: 200px;">
                                                {{ own_user_data.contact.facebook }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto m-2">    
                                        <!-- Instagram -->
                                        <div class="d-flex" style="color: #a201b4;">
                                            <i class="bi-instagram icon-size"></i>
                                            <div 
                                                id="team-instagram-{{own_user_data.id}}-1-1"
                                                data-editable 
                                                data-type="text"
                                                class="border rounded border-secondary-subtle p-2 ms-2 mb-2 text-secondary" 
                                                style="min-width: 200px;">
                                                {{ own_user_data.contact.instagram }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto m-2">    
                                        <!-- Twitter -->
                                        <div class="d-flex text-black">
                                            <i class="bi bi-twitter-x icon-size"></i>
                                            <div 
                                                id="team-twitter-{{own_user_data.id}}-1-1"
                                                data-editable 
                                                data-type="text"
                                                class="border rounded border-secondary-subtle p-2 ms-2 mb-2 text-secondary" 
                                                style="min-width: 200px;">
                                                {{ own_user_data.contact.twitter }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto m-2">    
                                        <!-- LinkedIn -->
                                        <div class="d-flex text-primary">
                                            <i class="bi-linkedin icon-size"></i>
                                            <div 
                                                id="team-linkedin-{{own_user_data.id}}-1-1"
                                                data-editable 
                                                data-type="text"
                                                class="border rounded border-secondary-subtle p-2 ms-2 mb-2 text-secondary" 
                                                style="min-width: 200px;">
                                                {{ own_user_data.contact.linkedin }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal błędów -->
                <div class="modal fade" id="error-modal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="errorModalLabel">Błąd</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="error-modal-message">Wystąpił nieoczekiwany błąd.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal sukcesów -->
                <div class="modal fade" id="success-modal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="successModalLabel">Sukces</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="success-modal-message">Operacja zakończona pomyślnie.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal potwierdzeń -->
                <div class="modal fade" id="confirm-modal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-white">
                                <h5 class="modal-title" id="confirmModalLabel">Potwierdź Działanie</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="confirm-modal-message">Czy na pewno chcesz wykonać tę operację?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                                <button type="button" class="btn btn-danger" id="confirm-modal-confirm">Potwierdź</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- appointment end -->
    {% endif %}

{% endblock %}
{% block bottom_scripts %}
    <script>
        $(document).ready(function () {
            setTimeout(function () {
                // Pokaż #breadcrumb-small
                $("#breadcrumb-small")
                    .css({
                        display: "block", // Ustaw widoczność
                        textAlign: "center", // Wyrównanie tekstu do środka
                        width: "100%", // Rozciągnij na całą szerokość
                    })
                    .animate(
                        {
                            height: "50px",
                            paddingTop: "10px"
                        },
                        1200 // Czas animacji
                    );
            }, 2000); 
        });
    </script>

    {% if userName!='NotLogin' %}
        <script>
            let role; // Deklaracja globalna
            document.addEventListener("DOMContentLoaded", function () {
                // Pobierz rolę użytkownika z backendu
                fetch('/api/get-role')
                    .then(response => response.json())
                    .then(data => {
                        role = data.role;
                        initializeUI(role); // Inicjalizacja UI na podstawie roli
                    })
                    .catch(error => {
                        console.error("Błąd podczas pobierania roli użytkownika:", error);
                    });

                // Funkcja inicjalizująca UI na podstawie roli
                function initializeUI(role) {
                    const userSelect = document.getElementById("userSelect");
                    const adminOptions = document.getElementById("adminOptions");
                    const submitButton = document.getElementById("submitButton");
                    const generateButton = document.getElementById("generateButton");
                    const oldPassword = document.getElementById("old_password");
                    const oldPasswordDiv = document.getElementById("old_password_div");
                    const newPassword = document.getElementById("new_password");
                    const repeatPassword = document.getElementById("repeat_password");
                    const generatePasswordSwitch = document.getElementById("generate_password");
                    const ownUserId = document.getElementById("own_user_id");
                    const userId = document.getElementById("user_id");
                    const adminPerm = document.getElementById(`perm-show-${ownUserId.value}`);
                    const adminPerm_C = document.getElementById(`perm-edit-${ownUserId.value}`);
                    

                    // Funkcja obsługująca przełącznik generowania hasła
                    function handlePasswordSwitch(switchElement, newPassword, repeatPassword) {
                        switchElement.addEventListener("change", function () {
                            const isGenerate = switchElement.checked;
                            newPassword.disabled = isGenerate;
                            repeatPassword.disabled = isGenerate;

                            if (isGenerate) {
                                newPassword.value = "";
                                repeatPassword.value = "";
                            }
                        });
                    }

                    // Dostosowanie widoku w zależności od roli użytkownika
                    if (role === "administrator") {
                        userSelect.style.display = "block"; // Admin widzi listę użytkowników
                        adminOptions.style.display = "block"; // Admin widzi przełącznik generowania hasła
                        adminPerm.style.display = "block"; // Admin widzi przełącznik generowania hasła
                        // oldPassword.parentElement.style.display = "none"; // Ukrywamy pole starego hasła
                        oldPasswordDiv.style.display = "none"; // Ukrywamy diva starego hasła
                        adminPerm_C.style.display = "block";

                        // Obsługa przełącznika generowania hasła
                        handlePasswordSwitch(generatePasswordSwitch, newPassword, repeatPassword);
                    } else if (role === "super_user") {
                        userSelect.style.display = "block"; // Super user nie widzi pełnej listy użytkowników
                        adminOptions.style.display = "block"; // Super user widzi przełącznik generowania hasła
                        // oldPassword.parentElement.style.display = "block"; // Musi podać stare hasło
                        oldPasswordDiv.style.display = "block"; // Pakazujemy diva starego hasła
                        // adminPerm.style.display = "none"; // Admin widzi przełącznik generowania hasła

                        // Obsługa przełącznika generowania hasła
                        handlePasswordSwitch(generatePasswordSwitch, newPassword, repeatPassword);
                    } else if (role === "user") {
                        userSelect.style.display = "none"; // Pracownik nie widzi listy użytkowników
                        adminOptions.style.display = "none"; // Pracownik nie ma przełącznika
                        // oldPassword.parentElement.style.display = "none"; // Pracownik nie musi podawać starego hasła
                        oldPasswordDiv.style.display = "none"; // Ukrywamy diva starego hasła
                        newPassword.parentElement.style.display = "none"; // Ukrywamy nowe hasło
                        repeatPassword.parentElement.style.display = "none"; // Ukrywamy powtórzenie hasła
                        // adminPerm.style.display = "none"; // Admin widzi przełącznik generowania hasła


                        generateButton.style.display = "block"; // Pracownik widzi przycisk generowania hasła
                        ownUserId.style.display = "block"; // Pracownik widzi ustawia swoje userId
                        
                        submitButton.style.display = "none"; // Ukrywamy standardowy przycisk zmiany hasła
                    } else {
                        console.warn("Nieznana rola użytkownika:", role);
                        // Domyślne zachowanie w przypadku nieznanej roli
                    }
                }
            });
            
            document.addEventListener('DOMContentLoaded', function () {
                // Ukryty input
                const hiddenInput = document.getElementById('user_id');
                const hiddenInput_own = document.getElementById('own_user_id');
                // Link wybranego użytkownika
                const selectedUserName = document.getElementById('selectedUserName');
                // Elementy listy użytkowników
                const userItems = document.querySelectorAll('.user-item');
                // Pole starego hasła
                const oldPasswordDiv = document.getElementById('old_password_div');

                userItems.forEach(item => {
                    item.addEventListener('click', function () {
                        // Pobierz dane użytkownika z klikniętego elementu
                        const userId = this.getAttribute('data-user-id');
                        const userName = this.getAttribute('data-user-name');

                        // Podmień wartość ukrytego inputa
                        hiddenInput.value = userId;

                        // Podmień tekst wybranego użytkownika
                        selectedUserName.textContent = userName;

                        // Zamknij collapse
                        const collapseInstance = bootstrap.Collapse.getInstance(document.getElementById('userListCollapse'));
                        collapseInstance.hide();

                        // Dodaj styl aktywnego użytkownika
                        userItems.forEach(user => user.classList.remove('active'));
                        this.classList.add('active');

                        // Ukrywanie/wyświetlanie oldPasswordDiv dla super_user i administrator
                        if (role === 'super_user') {
                            if (hiddenInput.value !== hiddenInput_own.value) {
                                oldPasswordDiv.style.display = 'none'; // Ukryj pole dla innego użytkownika
                            } else {
                                oldPasswordDiv.style.display = 'block'; // Pokaż pole dla siebie
                            }
                        } else if (role === 'administrator') {
                            oldPasswordDiv.style.display = 'none'; // Administrator nigdy nie widzi tego pola
                        }

                        // Jeśli rola to administrator, pokaż odpowiedni div
                        if (role === 'administrator') {
                            // Znajdź odpowiednie divy po ID
                            const divToShow_B = document.getElementById(`perm-show-${userId}`);
                            const divToShow_C = document.getElementById(`perm-edit-${userId}`);

                            if (divToShow_B || divToShow_C) {
                                // Ukryj wszystkie inne divy z prefiksem "perm-edit-"
                                document.querySelectorAll('[id^="perm-edit-"]').forEach(div => {
                                    div.style.display = 'none';
                                });
                                // Pokaż odpowiedni div perm-edit
                                if (divToShow_C) {
                                    divToShow_C.style.display = 'block';
                                }

                                // Ukryj wszystkie inne divy z prefiksem "perm-show-"
                                document.querySelectorAll('[id^="perm-show-"]').forEach(div => {
                                    div.style.display = 'none';
                                });
                                // Pokaż odpowiedni div perm-show
                                if (divToShow_B) {
                                    divToShow_B.style.display = 'block';
                                }
                            }
                        }
                    });
                });
            });



            // Przykładowa obsługa wysyłania formularza
            $("#passwordForm").on("submit", function (e) {
                e.preventDefault();

                const formData = $(this).serialize(); // Serializuj dane formularza

                $.ajax({
                    url: "/admin/manage-password",
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        // Wyświetlenie komunikatu o sukcesie
                        const responseMessage = $("#responseMessage");
                        responseMessage
                            .text(response.message) // Ustawienie treści wiadomości
                            .removeClass("alert-danger") // Usuń klasę błędu (jeśli istnieje)
                            .addClass("alert-success") // Dodaj klasę sukcesu
                            .show(); // Upewnij się, że element jest widoczny

                        // Ukrycie komunikatu po 10 sekundach
                        setTimeout(() => {
                            responseMessage.fadeOut(); // Ukryj element z animacją
                        }, 10000); // 10 sekund

                        // Czyszczenie formularza
                        const form = document.getElementById("passwordForm"); // Zmień na ID swojego formularza
                        if (form) {
                            form.reset(); // Resetuje wszystkie pola formularza
                        }
                    },
                    error: function (xhr) {
                        // Wyświetlenie komunikatu o błędzie
                        const response = JSON.parse(xhr.responseText);
                        const responseMessage = $("#responseMessage");
                        responseMessage
                            .text(response.message) // Ustawienie treści wiadomości
                            .removeClass("alert-success") // Usuń klasę sukcesu (jeśli istnieje)
                            .addClass("alert-danger") // Dodaj klasę błędu
                            .show(); // Upewnij się, że element jest widoczny

                        // Ukrycie komunikatu po 10 sekundach
                        setTimeout(() => {
                            responseMessage.fadeOut(); // Ukryj element z animacją
                        }, 10000); // 10 sekund
                    },

                });
            });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
        <script>
            // Funkcja wyświetlająca modal błędów
            function showErrorModal(message) {
                const errorModal = new bootstrap.Modal(document.getElementById('error-modal'));
                document.getElementById('error-modal-message').textContent = message || 'Wystąpił nieoczekiwany błąd.';
                errorModal.show();
            }

            // Funkcja wyświetlająca modal sukcesów
            function showSuccessModal(message, callback) {
                const successModal = new bootstrap.Modal(document.getElementById('success-modal'));
                document.getElementById('success-modal-message').textContent = message || 'Operacja zakończona pomyślnie.';
                successModal.show();

                const modalElement = document.getElementById('success-modal');
                modalElement.addEventListener('hidden.bs.modal', function onHidden() {
                    if (callback) callback();
                    modalElement.removeEventListener('hidden.bs.modal', onHidden);
                });
            }

            // Funkcja wyświetlająca modal potwierdzeń
            function showConfirmModal(message, onConfirm) {
                const confirmModal = new bootstrap.Modal(document.getElementById('confirm-modal'));
                document.getElementById('confirm-modal-message').textContent = message || 'Czy na pewno chcesz kontynuować?';

                const confirmButton = document.getElementById('confirm-modal-confirm');
                const cancelButton = document.querySelector('#confirm-modal .btn-secondary');

                // Dodaj obsługę kliknięcia na "Potwierdź"
                confirmButton.onclick = function () {
                    confirmModal.hide();
                    if (typeof onConfirm === 'function') {
                        onConfirm(true); // Wywołaj callback z wartością true
                    }
                };

                // Dodaj obsługę kliknięcia na "Anuluj"
                cancelButton.onclick = function () {
                    confirmModal.hide();
                    if (typeof onConfirm === 'function') {
                        onConfirm(false); // Wywołaj callback z wartością false
                    }
                };

                confirmModal.show();
            }

            function makeElementEditable(element) {
                const dataType = element.getAttribute('data-type');
                const elementId = element.getAttribute('id');

                if (dataType === 'img') {
                    // Obsługa obrazka (bez zmian)
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';

                    fileInput.addEventListener('change', () => {
                        const file = fileInput.files[0];
                        if (!file) return;

                        // Wywołanie modala z callbackiem
                        showConfirmModal('Czy na pewno chcesz załadować to zdjęcie?', (confirmUpload) => {
                            if (!confirmUpload) return;

                            const formData = new FormData();
                            formData.append('id', elementId);
                            formData.append('type', dataType);
                            formData.append('file', file);

                            // Wysyłanie pliku po potwierdzeniu
                            sendFileToBackend(formData, element);
                            showSuccessMessage(`Zdjęcie o ID ${elementId} zostało zaktualizowane! Poczekaj na przeładowanie aplikacji!`, elementId);
                        });
                    });

                    fileInput.click();
                } else if (dataType === 'picker') {
                    // Obsługa typu picker
                    fetchPickerOptions(elementId)
                        .then((options) => {
                            const selectElement = document.createElement('select');
                            selectElement.className = 'form-select'; // Bootstrap style (opcjonalnie)

                            // Dodanie opcji do selecta
                            options.forEach(({ id, description }) => {
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = description;
                                selectElement.appendChild(option);
                            });

                            // Ustawienie początkowej wartości
                            const currentValue = element.getAttribute('data-current-value');
                            if (currentValue) {
                                selectElement.value = currentValue;
                            }

                            // Zamiana elementu na selecta
                            element.replaceWith(selectElement);

                            // Obsługa wyboru i wysyłki danych
                            selectElement.addEventListener('change', () => {
                                const selectedValue = selectElement.value;
                                sendDataToBackend(elementId, dataType, selectedValue);

                                // Zamiana selecta na oryginalny element z aktualizacją
                                element.textContent = options.find((opt) => opt.id == selectedValue).description;
                                element.setAttribute('data-current-value', selectedValue);

                                const expacter_array = ['treatment-icon-'];
                                // Pobranie wybranego opisu z tekstu opcji
                                const selectedOpis = selectElement.options[selectElement.selectedIndex].innerText;

                                if (!expacter_array.some(prefix => elementId.startsWith(prefix))) {
                                    selectElement.replaceWith(element); // Jeśli elementId nie pasuje do żadnego prefiksu
                                } else {
                                    // Użycie klasy na podstawie tekstu opisu
                                    const iconClass = selectedOpis || 'default-icon-class';

                                    // Tworzenie nowego elementu <i>
                                    const iconElement = document.createElement('i');
                                    iconElement.className = `${iconClass} icon-size me-3`;

                                    // Zastąpienie elementu nowym elementem <i>
                                    selectElement.replaceWith(iconElement);
                                }

                                showSuccessMessage(`Wskazanie o ID ${elementId} zostało dokonane! Poczekaj na przeładowanie aplikacji!`, elementId);
                            });
                        })
                        .catch((error) => {
                            console.error('Błąd wczytywania opcji:', error);
                        });
                } else if (dataType === 'adder') {
                    // Zapamiętanie oryginalnego elementu przed zmianą
                    const originalElement = element.cloneNode(true);

                    fetchPickerOptions(elementId)
                        .then((options) => {
                            // Tworzenie elementu select
                            const selectElement = document.createElement('select');
                            selectElement.className = 'form-select';
                            
                            // Dodanie opcji "Wybierz" na początek
                            const defaultOption = document.createElement('option');
                            defaultOption.value = 0;
                            defaultOption.textContent = 'Wybierz';
                            selectElement.appendChild(defaultOption);

                            // Dodanie opcji do selecta
                            options.forEach(({ id, description }) => {
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = description;
                                selectElement.appendChild(option);
                            });

                            // Zamiana elementu na select
                            element.replaceWith(selectElement);

                            // Obsługa zdarzenia change
                            selectElement.addEventListener('change', () => {
                                const selectedValue = selectElement.value;

                                // Wysyłanie wybranej wartości do backendu
                                sendDataToBackend(elementId, dataType, selectedValue);

                                // Przywrócenie pierwotnego elementu
                                originalElement.setAttribute('data-current-value', selectedValue); // Aktualizacja wartości
                                selectElement.replaceWith(originalElement);

                                // Bezpośrednie przypisanie zdarzenia dblclick do przywróconego elementu
                                originalElement.addEventListener('dblclick', () => makeElementEditable(originalElement));
                                originalElement.setAttribute('data-initialized', 'true'); // Zapobiega wielokrotnej inicjalizacji

                                // Wyświetlenie informacji o sukcesie
                                showSuccessMessage(`Pozycja o ID ${selectedValue} została dodana! Poczekaj na przeładowanie aplikacji!`, elementId);

                                console.log(`Dodano element o ID: ${selectedValue} i przywrócono pierwotny stan.`);
                            });
                        })
                        .catch((error) => {
                            console.error('Błąd wczytywania opcji:', error);
                        });
                } else if (dataType === 'remover') {
                    // Obsługa typu remover
                    showConfirmModal('Czy na pewno chcesz usunąć ten element?', (confirmRemove) => {
                        if (confirmRemove) {
                            sendDataToBackend(elementId, dataType, null);
                            // Wyświetlenie informacji o sukcesie
                            showSuccessMessage(`Pozycja o ID ${elementId} została usunięta! Poczekaj na przeładowanie aplikacji!`, "");
                        }
                    });
                } else if (dataType === 'url') {
                        // Otwartą logikę pozostawiamy na później
                        console.log(`Logic for URL is not yet implemented for element ${elementId}.`);
                        showErrorModal('Obsługa URL jest w trakcie wdrażania. Spróbuj później.');
                } else {
                    // Obsługa innych typów danych
                    element.setAttribute('contenteditable', 'true');
                    element.focus();
                    element.style.border = '2px dashed #007bff';

                    element.addEventListener(
                        'blur',
                        () => {
                            element.setAttribute('contenteditable', 'false');
                            element.style.border = 'none';

                            const updatedValue = element.innerText.trim();
                            if (!validateInput(updatedValue, dataType)) {
                                showErrorModal('Nieprawidłowa wartość!');
                                return;
                            }

                            const processedValue = processDataType(dataType, updatedValue);
                            sendDataToBackend(elementId, dataType, processedValue);
                        },
                        { once: true }
                    );
                }
            }

            function showSuccessMessage(message, elementID) {
                // Tworzenie elementu z wiadomością
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messageElement.className = 'success-message';
                document.body.appendChild(messageElement);

                // Usuwanie wiadomości po 5 sekundach
                setTimeout(() => {
                    messageElement.style.opacity = '0'; // Rozpoczęcie animacji zanikania
                    setTimeout(() => {
                        messageElement.remove(); // Usunięcie elementu
                        // Przeładowanie strony i przewinięcie do wskazanego elementu
                        window.location.href = `${window.location.origin}${window.location.pathname}#${elementID}`;
                        window.location.reload();
                    }, 1000); // Czas trwania animacji
                }, 5000); // Czas wyświetlania wiadomości
            }



            function fetchPickerOptions(elementId) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: '/admin/get-picker-options',
                        type: 'GET',
                        data: { id: elementId },
                        success: (response) => {
                            if (response.options) {
                                resolve(response.options); // Zakładamy, że backend zwraca listę obiektów { id, description }
                            } else {
                                reject('Brak opcji w odpowiedzi.');
                            }
                        },
                        error: (xhr) => {
                            reject('Błąd wczytywania opcji: ' + xhr.responseJSON.error);
                        }
                    });
                });
            }

            // Funkcja walidacji podstawowej
            function validateInput(value, dataType) {
                switch (dataType) {
                    case 'text':
                        return true; // value.length > 0;
                    case 'picker':
                    case 'adder': // Walidacja dla picker i adder
                        return !isNaN(parseInt(value));
                    case 'remover': // Walidacja dla remover (zwraca true zawsze)
                        return true;
                    case 'img':
                    case 'url':
                        const urlPattern = /^(https?:\/\/)?([a-zA-Z0-9.-]+)\.([a-zA-Z]{2,})(:[0-9]{1,5})?(\/.*)?$/;
                        return urlPattern.test(value);
                    default:
                        console.warn(`Nieznany typ danych: ${dataType}`);
                        return false;
                }
            }

            // Funkcja przetwarzania danych
            function processDataType(dataType, value) {
                switch (dataType) {
                    case 'text':
                        return value.trim(); // Usuwa niepotrzebne spacje
                    case 'picker':
                    case 'adder': // Adder przetwarzany podobnie jak picker
                        return parseInt(value);
                    case 'remover': // Remover zwraca zawsze null
                        return null;
                    case 'img':
                    case 'url':
                        return value.trim(); // Usuwa spacje z początku i końca
                    default:
                        console.warn(`Nieznany typ danych: ${dataType}`);
                        return value;
                }
            }

            // Funkcja do wysyłania danych do backendu
            function sendDataToBackend(id, type, value) {
                $.ajax({
                    url: '/admin/edytuj-wybrany-element',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ id, type, value }),
                    success: (response) => {
                        console.log('Zaktualizowano:', response.message);
                    },
                    error: (xhr) => {
                        console.error('Błąd aktualizacji:', xhr.responseJSON.error);
                    }
                });
            }

            // Funkcja do przesyłania plików do backendu
            function sendFileToBackend(formData, element) {
                $.ajax({
                    url: '/admin/edytuj-wybrany-element',
                    type: 'POST',
                    processData: false, // Ważne przy używaniu FormData
                    contentType: false,
                    data: formData,
                    success: (response) => {
                        console.log('Zdjęcie zaktualizowano:', response.message);

                        // Opcjonalnie: Ustaw nowe zdjęcie w elemencie
                        const newImageUrl = response.newImageUrl; // URL zwracany przez backend
                        if (newImageUrl) {
                            element.src = newImageUrl;
                        }
                    },
                    error: (xhr) => {
                        console.error('Błąd podczas aktualizacji zdjęcia:', xhr.responseJSON.error);
                    }
                });
            }

            function initializeEditableElements() {
                const editableElements = document.querySelectorAll('[data-editable]');
                editableElements.forEach((element) => {
                    if (!element.hasAttribute('data-initialized')) { // Unikamy dodawania eventów dwa razy
                        element.addEventListener('dblclick', () => makeElementEditable(element));
                        element.setAttribute('data-initialized', 'true');
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', initializeEditableElements);


            // // //  // // //  //      //        //
            //        //    //  //        //   //
            // // //  // // //  //          //
                //  //        //        //  //
            // // //  //        // //  //       //


            // // // SPLX 
            //   
            // // // Logika dynamicznej listy z edytowalnymi polami // // //
            //   
            // // // Funkcje do dodawania, usuwania, sortowania i eksportu danych // // //

            // SPLX V 2.0
            // Szablon elementu listy
            const template = `
                <div class="item-container d-flex align-items-center mb-2">
                    <div class="drag-handle me-2">
                        <i class="bi bi-grip-vertical" style="cursor: grab;"></i>
                    </div>
                    <div class="editable-content flex-grow-1 p-2 fs-6 bg-light text-dark" contenteditable="true">
                        &^^idemDiv&^^
                    </div>
                    <button type="button" class="remove-btn btn btn-outline-danger ms-2">
                        <i class="bi bi-trash3-fill" style="font-size: 15px;"></i>
                    </button>
                </div>
            `;

            // Funkcja do wczytywania elementów z danych
            function addListFields(data, id, sep, template, containerID) {
                const container = document.getElementById(containerID + id);
                if (!container) {
                    console.error(`Container with ID ${containerID + id} does not exist.`);
                    return;
                }

                const html = data.split(sep)
                    .map(value => template.replace("&^^idemDiv&^^", value))
                    .join("");

                container.innerHTML += html;
            }

            // Funkcja do dodawania nowego elementu
            function addListItem(id, template, containerID, defaultValue = "") {
                const container = document.getElementById(containerID + id);
                if (!container) {
                    console.error(`Container with ID ${containerID + id} does not exist.`);
                    return;
                }

                container.insertAdjacentHTML(
                    'beforeend',
                    template.replace("&^^idemDiv&^^", defaultValue)
                );
            }

            // Funkcja do eksportu danych
            function joinListFields(containerID, separator = "#splx#") {
                const container = document.getElementById(containerID);
                if (!container) {
                    console.error(`Container with ID ${containerID} does not exist.`);
                    return "";
                }

                const items = Array.from(container.querySelectorAll(".editable-content"));

                const processedItems = items.map((item) => {
                    return item.innerText.replace(/\s+/g, " ").trim();
                });

                return processedItems.join(separator);
            }

            // Funkcja eksportu wywoływana z przycisku
            function exportList(id, validate = true) {
                // Pobierz dane do eksportu
                const exportedData = joinListFields(`list-container_${id}`, "#splx#");

                // Walidacja danych (tylko jeśli validate = true)
                if (validate && exportedData === "") {
                    alert("Lista jest pusta, brak danych do eksportu.");
                    return;
                }

                // Typ danych i wartość do przesłania
                const type = 'splx';
                const value = exportedData;

                // Wyślij dane do backendu
                sendDataToBackend(id, type, value);
                showSuccessMessage(`Lista o ID ${id} zostało wyeksportowana! Poczekaj na przeładowanie aplikacji!`, id);
                console.log("Eksportowane dane:", exportedData);
                // alert("Eksportowane dane:\n" + exportedData); // Opcjonalne alerty
            }

            // Inicjalizacja SortableJS
            function initializeSortable(containerID) {
                const container = document.getElementById(containerID);
                if (!container) {
                    console.error(`Container with ID ${containerID} does not exist.`);
                    return;
                }

                new Sortable(container, {
                    animation: 150,
                    ghostClass: "sortable-ghost",
                    onEnd: function (evt) {
                        console.log(`Element przeniesiony z pozycji ${evt.oldIndex} na pozycję ${evt.newIndex}`);
                    }
                });
            }

            // Obsługa usuwania elementów
            document.addEventListener("click", function (e) {
                if (e.target && e.target.closest(".remove-btn")) {
                    const item = e.target.closest(".item-container");
                    if (item) item.remove();
                }
            });

            // // // SWX 
            //   
            // // // Logika przełącznika z dwoma stanami: ON i OFF // // //
            //   
            // // // Funkcje do zarządzania stanem: ustawianie, odczyt, zapis i reset // // //

            // SWX V 1.0
            document.addEventListener('click', (event) => {
                const element = event.target;

                // Sprawdź, czy kliknięty element ma atrybut data-type="switch"
                if (element.getAttribute('data-type') === 'switch') {
                    const elementId = element.getAttribute('id');
                    const currentState = parseInt(element.getAttribute('data-state'), 10);

                    // Sprawdzenie aktualnego stanu i przełączenie
                    const newState = currentState === 0 ? 1 : 0;
                    showConfirmModal(`Czy na pewno chcesz zmienić stan elementu na ${newState === 1 ? 'ON' : 'OFF'}?`, (confirmRemove) => {
                        if (confirmRemove) {
                            // Zaktualizowanie stanu w atrybucie HTML
                            element.setAttribute('data-state', newState);
                            // Wysłanie danych do backendu
                            sendDataToBackend(elementId, 'switch', newState);
                            // Wyświetlenie komunikatu o powodzeniu
                            showSuccessMessage(
                                `Stan elementu o ID ${elementId} został zmieniony na ${newState === 1 ? 'ON' : 'OFF'}!`,
                                elementId
                            );
                        }
                    });
                }
            });
        </script>
    {% endif %}
{% endblock %}